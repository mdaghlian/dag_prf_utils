#!/usr/bin/env python
#$ -j Y
#$ -cwd
#$ -V

import os
opj = os.path.join
import pickle
import sys
import numpy as np
import re
import scipy.io
try:
    from prfpy_csenf.stimulus import PRFStimulus2D
    from prfpy_csenf.model import Iso2DGaussianModel, Norm_Iso2DGaussianModel, DoG_Iso2DGaussianModel, CSS_Iso2DGaussianModel, CSenFModel
except:
    from prfpy.stimulus import PRFStimulus2D
    from prfpy.model import Iso2DGaussianModel, Norm_Iso2DGaussianModel, DoG_Iso2DGaussianModel, CSS_Iso2DGaussianModel

from dag_prf_utils.prfpy_ts_plotter import TSPlotter
from dag_prf_utils.mesh_dash import MeshDash, dag_mesh_pickle
from dag_prf_utils.utils import dag_hyphen_parse

def main(argv):
    '''
    ---------------------------
    Auto open a subject surface with either numpy or pickle values

    Args:
        path        path to pickle/numpy file file
        sub         subject number
        fs_dir      freesurfer director
        outputdir   where to put it

    '''
    sub = None
    fs_dir = os.environ['SUBJECTS_DIR']
    dump = False
    file_name = 'mesh_dash.pickle'
    model = None
    outputdir = opj(os.getcwd(), 'z_dump', file_name.replace('.pickle', ''))#opj(os.environ['DPU_REPO_DIR'], 'z_dump')    
    real_ts = None
    dm_file = None
    for i,arg in enumerate(argv):        
        if '--path' in arg:                        
            file_path = argv[i+1]            
        elif '--sub' in arg:
            sub = dag_hyphen_parse('sub', argv[i+1])
        elif '--model' in arg:
            model = argv[i+1]            
        elif '--fs_dir' in arg:
            fs_dir = argv[i+1]  
        elif '--outputdir' in arg:
            outputdir = argv[i+1]              
        elif '--dump' in arg:
            dump = True
        elif '--file_name' in arg:
            file_name = argv[i+1]
        elif '--real_ts' in arg:
            real_ts = argv[i+1]
        elif '--dm_file' in arg:
            dm_file = argv[i+1]            
        elif arg in ('-h', '--help'):
            print(main.__doc__)
            sys.exit()

    # Load the fitting settings, add in the new info
    if sub is None:
        sub = 'sub-'
        sub += re.search(r'sub-(.*?)_', file_path).group(1)
    
    # Check for model info in the file path
    
    if 'model' in file_path:
        pattern = r'model-(.*?)_'
        model = re.search(pattern, file_path).group(1)

    data_info = {
        'pars':[], 
        'prfpy_model':None, 
        'real_ts':None, 
        'settings': None
        }
    if '.pkl' in file_path:
        # Assume store under pars
        with open(file_path, 'rb') as f:
            pickle_dict = pickle.load(f)
        for k in data_info.keys():
            if k in pickle_dict.keys():
                data_info[k] = pickle_dict[k]
        
    elif '.npy' in file_path:
        data_info['pars'] = np.load(file_path)
    
    # Can we find the real timeseries somewhere else?
    if (real_ts is not None) and (data_info['real_ts'] is None):
        data_info['real_ts'] = np.load(real_ts)
        # Quick check, is it nvx X time?
        if data_info['real_ts'].shape[0]<data_info['real_ts'].shape[1]:
            data_info['real_ts'] = data_info['real_ts'].T

    
    # Can we remake the prfpy model?
    if (data_info['prfpy_model'] is None) and (dm_file is not None) and (model is not None):
        if '.mat' in dm_file:
            dm_npy = scipy.io.loadmat(dm_file)['stim']
        else:
            dm_npy = np.load(dm_file)
        cut_vols = data_info['settings'].get('cut_vols', None)        
        prfpy_stim = PRFStimulus2D(
            screen_size_cm=data_info['settings']['screen_size_cm'],
            screen_distance_cm=data_info['settings']['screen_distance_cm'],
            design_matrix=dm_npy[:,:,cut_vols:], 
            axis=0,
            TR=data_info['settings']['TR']
            )    
        if 'gauss' in model:
            data_info['prfpy_model'] = Iso2DGaussianModel(prfpy_stim)
        elif 'norm' in model:
            data_info['prfpy_model'] = Norm_Iso2DGaussianModel(prfpy_stim)
        elif 'dog' in model:
            data_info['prfpy_model'] = DoG_Iso2DGaussianModel(prfpy_stim) 
        elif 'css' in model:
            data_info['prfpy_model'] = CSS_Iso2DGaussianModel(prfpy_stim)                       
        
        
    if not os.path.exists(outputdir):
        os.makedirs(outputdir)
    # Make the mesh dash object
    fs = MeshDash(
        sub=sub, 
        fs_dir=fs_dir,
        output_dir=outputdir,
        )    
    # bloop
    fs.web_get_ready()
    
    if model is not None:
        try:
            prf_obj = TSPlotter(
                prf_params=data_info['pars'],
                model=model,
                prfpy_model=data_info['prfpy_model'],
                real_ts = data_info['real_ts'],            
                incl_hrf=True, 
            )
        except:
            prf_obj = TSPlotter(
                prf_params=data_info['pars'],
                model=model,
                prfpy_model=data_info['prfpy_model'],
                real_ts = data_info['real_ts'],            
                incl_hrf=False, 
            )            

        for p in prf_obj.pd_params.keys():
            data        = prf_obj.pd_params[p].to_numpy()
            data4mask   = prf_obj.pd_params['rsq'].to_numpy()
            if p=='pol':
                cmap = 'marco_pol'
                vmin,vmax = -np.pi, np.pi
                kwargs = dict(cmap=cmap, vmin=vmin, vmax=vmax)
            elif p=='ecc':
                cmap = 'ecc2'
                vmin,vmax = 0, 5
                kwargs = dict(cmap=cmap, vmin=vmin, vmax=vmax)
            elif p=='rsq':
                cmap='plasma'
                vmin,vmax = 0,1
                kwargs = dict(cmap=cmap, vmin=vmin, vmax=vmax)                
            else:
                kwargs = {}
            
            fs.web_add_vx_col(
                data=data, 
                # data_alpha=data_alpha, 
                data4mask = data4mask,
                rsq_thresh=0.1, 
                vx_col_name=p,  
                **kwargs,  
            )
            # break
        fs.web_add_mpl_fig_maker(
            prf_obj.prf_ts_plot, f'plot',
            mpl_kwargs={'return_fig':True},
        )
    else:
        # We don't know what everything is... 
        # assume last column is rsq
        for p in np.arange(data_info['pars'].shape[1]):
            data        = data_info['pars'][:,p]
            data4mask   = data_info['pars'][:,-1]            
            fs.web_add_vx_col(
                data=data, 
                data4mask = data4mask,
                rsq_thresh=0.1, 
                vx_col_name=p,    
            )
    if dump:
        dag_mesh_pickle(fs, file_name=file_name)
        return
    app = fs.web_launch_with_dash()
    # Open the app in a browser
    # Do not show it in the notebook
    print(f'http://localhost:8000/')
    app.run_server(host='127.0.0.1', port=8000, debug=False, use_reloader=False) 



if __name__ == "__main__":
    main(sys.argv[1:])    


